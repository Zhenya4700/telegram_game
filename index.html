<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞–ø–∞–ª–∫–∞ —á–ª–µ–Ω–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(145deg, #1a1e2c 0%, #2a2f42 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            color: white;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 48px;
            padding: 32px 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 90%;
            max-width: 380px;
            text-align: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 40px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff99cc, #b3d9ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: #1a1e2c;
        }

        .username {
            font-weight: 600;
            flex: 1;
            text-align: left;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #ff99cc, #b3d9ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tap-area {
            width: 200px;
            height: 200px;
            margin: 15px auto 20px;
            background: radial-gradient(circle at 30% 30%, #ffd966, #e68a2e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 15px 0 #b3540b, 0 20px 30px rgba(0, 0, 0, 0.6);
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            border: 3px solid #ffb347;
        }

        .tap-area:active {
            transform: translateY(8px);
            box-shadow: 0 8px 0 #b3540b, 0 15px 25px rgba(0, 0, 0, 0.6);
        }

        .tap-area.cooldown {
            opacity: 0.6;
            filter: grayscale(50%);
            cursor: not-allowed;
            pointer-events: none;
            transform: translateY(5px);
            box-shadow: 0 8px 0 #7a4a1f;
            animation: none;
        }

        .tap-area.ready {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 #ffd966, 0 15px 0 #b3540b; }
            70% { box-shadow: 0 0 0 20px rgba(255, 215, 0, 0), 0 15px 0 #b3540b; }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0), 0 15px 0 #b3540b; }
        }

        .size-display {
            font-size: 4rem;
            font-weight: 900;
            color: #ffe484;
            text-shadow: 0 3px 0 #b3540b, 0 5px 15px black;
            line-height: 1;
            margin-bottom: 5px;
        }

        .size-label {
            font-size: 1.5rem;
            color: #f5c6a0;
            margin-bottom: 5px;
        }

        .change-indicator {
            font-size: 2rem;
            font-weight: bold;
            min-height: 50px;
            margin: 5px 0;
        }

        .positive { color: #4caf50; }
        .negative { color: #f44336; }

        .timer-text {
            font-size: 1.3rem;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px 20px;
            border-radius: 50px;
            display: inline-block;
            color: #aaa;
            border: 1px solid #444;
            margin: 15px 0;
        }

        .timer-text.active {
            color: #ffd966;
            border-color: #ffd966;
        }

        .error-message {
            color: #f44336;
            background: rgba(244, 67, 54, 0.1);
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #1a1e2c;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #3a3f55;
            border-top-color: #ffd966;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        footer {
            margin-top: 20px;
            font-size: 0.8rem;
            color: #6a6f84;
        }

        .reset-btn {
            background: #3a3f55;
            color: white;
            border: none;
            font-size: 1rem;
            padding: 10px 20px;
            border-radius: 40px;
            margin-top: 15px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid #1e2230;
        }

        .reset-btn:active {
            transform: translateY(3px);
            border-bottom-width: 1px;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</div>
    </div>

    <div class="game-container" id="gameContent" style="display: none;">
        <div class="user-info">
            <div class="avatar" id="avatar">üë§</div>
            <div class="username" id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <h1>‚ö° MEM-–º–µ—Ç—Ä ‚ö°</h1>

        <div class="tap-area" id="tapCircle"></div>
        
        <div class="size-display" id="sizeValue">0</div>
        <div class="size-label">—Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–æ–≤</div>
        <div class="change-indicator" id="changeIndicator"></div>
        
        <div class="timer-text" id="timerDisplay">‚ö° –≥–æ—Ç–æ–≤ ‚ö°</div>
        
        <div class="error-message" id="errorMessage"></div>

        <button class="reset-btn" id="resetBtn">‚ü≤ –°–±—Ä–æ—Å–∏—Ç—å</button>

        <footer>—Ç–∞–ø–∞–π —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É</footer>
    </div>

    <script>
        // ==================================
        // –í–ï–†–°–ò–Ø –ë–ï–ó –°–ï–†–í–ï–†–ê - Telegram Cloud Storage
        // ==================================

        let tg = window.Telegram.WebApp;
        tg.expand();
        
        let user = tg.initDataUnsafe?.user;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const loading = document.getElementById('loading');
        const gameContent = document.getElementById('gameContent');
        const avatar = document.getElementById('avatar');
        const usernameEl = document.getElementById('username');
        const sizeEl = document.getElementById('sizeValue');
        const changeEl = document.getElementById('changeIndicator');
        const timerEl = document.getElementById('timerDisplay');
        const errorEl = document.getElementById('errorMessage');
        const circle = document.getElementById('tapCircle');
        const resetBtn = document.getElementById('resetBtn');
        
        // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let size = 0;
        let lastClickTime = 0;
        let cooldown = false;
        let timerInterval = null;
        
        function showError(text) {
            errorEl.textContent = text;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 2000);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ Cloud Storage
        async function loadFromCloud() {
            if (!user) {
                // –î–µ–º–æ-—Ä–µ–∂–∏–º
                usernameEl.textContent = '–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º';
                avatar.textContent = 'üë§';
                loadFromLocalStorage();
                return;
            }
            
            usernameEl.textContent = user.first_name || user.username || '–ò–≥—Ä–æ–∫';
            avatar.textContent = (user.first_name ? user.first_name[0] : 'üë§').toUpperCase();
            
            try {
                // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞–∑–º–µ—Ä
                tg.CloudStorage.getItem('memberSize', function(err, value) {
                    if (!err && value !== null) {
                        size = parseInt(value) || 0;
                    } else {
                        size = 0;
                    }
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–ª–∏–∫–∞
                    tg.CloudStorage.getItem('lastClick', function(err2, timeValue) {
                        if (!err2 && timeValue !== null) {
                            lastClickTime = parseInt(timeValue) || 0;
                        }
                        
                        updateSize();
                        checkCooldown();
                        
                        loading.style.display = 'none';
                        gameContent.style.display = 'block';
                    });
                });
            } catch (e) {
                console.log('Cloud Storage error, using localStorage');
                loadFromLocalStorage();
            }
        }
        
        // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
        function loadFromLocalStorage() {
            size = localStorage.getItem('memberSize') ? parseInt(localStorage.getItem('memberSize')) : 0;
            lastClickTime = localStorage.getItem('lastClick') ? parseInt(localStorage.getItem('lastClick')) : 0;
            
            updateSize();
            checkCooldown();
            
            loading.style.display = 'none';
            gameContent.style.display = 'block';
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        function saveToCloud() {
            if (!user) {
                localStorage.setItem('memberSize', size.toString());
                localStorage.setItem('lastClick', lastClickTime.toString());
                return;
            }
            
            try {
                tg.CloudStorage.setItem('memberSize', size.toString(), function(err) {
                    if (err) console.log('Error saving size:', err);
                });
                tg.CloudStorage.setItem('lastClick', lastClickTime.toString(), function(err) {
                    if (err) console.log('Error saving time:', err);
                });
            } catch (e) {
                localStorage.setItem('memberSize', size.toString());
                localStorage.setItem('lastClick', lastClickTime.toString());
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—É–ª–¥–∞—É–Ω–∞
        function checkCooldown() {
            const now = Date.now();
            const diff = (now - lastClickTime) / 1000;
            
            if (diff < 1 && lastClickTime > 0) {
                startCooldown(1 - diff);
            } else {
                circle.classList.remove('cooldown');
                circle.classList.add('ready');
                timerEl.textContent = '‚ö° –≥–æ—Ç–æ–≤ ‚ö°';
                timerEl.classList.remove('active');
                cooldown = false;
            }
        }
        
        function startCooldown(seconds) {
            cooldown = true;
            circle.classList.add('cooldown');
            circle.classList.remove('ready');
            
            let timeLeft = seconds;
            
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                
                if (timeLeft <= 0.05) {
                    clearInterval(timerInterval);
                    cooldown = false;
                    circle.classList.remove('cooldown');
                    circle.classList.add('ready');
                    timerEl.textContent = '‚ö° –≥–æ—Ç–æ–≤ ‚ö°';
                    timerEl.classList.remove('active');
                } else {
                    timerEl.textContent = `‚è≥ ${timeLeft.toFixed(1)}—Å`;
                    timerEl.classList.add('active');
                }
            }, 100);
        }
        
        function handleTap() {
            if (cooldown) return;
            
            const now = Date.now();
            
            if (lastClickTime > 0) {
                const diff = (now - lastClickTime) / 1000;
                if (diff < 1) {
                    startCooldown(1 - diff);
                    return;
                }
            }
            
            // –†–∞–Ω–¥–æ–º –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–æ—Ç -10 –¥–æ +10)
            let change = Math.floor(Math.random() * 21) - 10;
            size += change;
            lastClickTime = now;
            
            saveToCloud();
            updateSize();
            showChange(change);
            startCooldown(1);
        }
        
        function resetGame() {
            if (confirm('–°–±—Ä–æ—Å–∏—Ç—å —Ä–∞–∑–º–µ—Ä –¥–æ 0?')) {
                size = 0;
                lastClickTime = 0;
                saveToCloud();
                updateSize();
                
                if (timerInterval) clearInterval(timerInterval);
                cooldown = false;
                circle.classList.remove('cooldown');
                circle.classList.add('ready');
                timerEl.textContent = '‚ö° –≥–æ—Ç–æ–≤ ‚ö°';
                timerEl.classList.remove('active');
            }
        }
        
        function updateSize() {
            sizeEl.textContent = size;
        }
        
        function showChange(change) {
            if (change > 0) {
                changeEl.innerHTML = `<span class="positive">+${change}</span>`;
            } else if (change < 0) {
                changeEl.innerHTML = `<span class="negative">${change}</span>`;
            } else {
                changeEl.innerHTML = `<span>0</span>`;
            }
            
            setTimeout(() => {
                changeEl.innerHTML = '';
            }, 800);
        }
        
        // –ó–∞–ø—É—Å–∫
        loadFromCloud();
        
        // –°–æ–±—ã—Ç–∏—è
        circle.addEventListener('click', handleTap);
        resetBtn.addEventListener('click', resetGame);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', function() {
            saveToCloud();
        });
    </script>
</body>
</html>
